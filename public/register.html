<script>
    let firebaseConfig = {}; // Deklarasikan di luar untuk lingkup yang lebih luass

    async function fetchFirebaseConfig() {
        try {
            const response = await fetch('/.netlify/functions/login-config'); // Mengambil dari fungsi yang sama
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            firebaseConfig = await response.json();
            initializeFirebase();
        } catch (error) {
            console.error('Error fetching Firebase config:', error);
            document.getElementById('errorMessage').textContent = 'Gagal memuat konfigurasi. Silakan coba lagi.';
        }
    }

    function initializeFirebase() {
        // Inisialisasi Firebase hanya setelah konfigurasi dimuat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const adminRef = database.ref('admin'); // Path to your admin users

        const registerForm = document.getElementById('registerForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('errorMessage');

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.textContent = ''; // Clear previous errors

            const username = usernameInput.value;
            const password = passwordInput.value;

            try {
                const snapshot = await adminRef.orderByChild('username').equalTo(username).once('value');
                if (snapshot.exists()) {
                    errorMessage.textContent = 'Nama pengguna sudah ada. Silakan gunakan nama pengguna lain.';
                    return;
                }

                const newAdminRef = adminRef.push(); // Generate a unique ID
                await newAdminRef.set({
                    id: newAdminRef.key, // Use the generated key as the ID
                    username: username,
                    password: password, // In a real application, HASH THIS PASSWORD!
                    admin: "not" // Default status for new registrations
                });
                errorMessage.style.color = 'green';
                errorMessage.textContent = 'Pendaftaran berhasil! Silakan tunggu persetujuan admin untuk login.';
                usernameInput.value = '';
                passwordInput.value = '';
                // Optional: Redirect to login page after successful registration
                // setTimeout(() => {
                //     window.location.href = 'login.html';
                // }, 3000);
            } catch (error) {
                console.error('Registration error:', error);
                errorMessage.textContent = 'Pendaftaran gagal. Silakan coba lagi.';
            }
        });
    }

    // Panggil fungsi untuk mengambil konfigurasi saat halaman dimuat
    document.addEventListener('DOMContentLoaded', fetchFirebaseConfig);
</script>